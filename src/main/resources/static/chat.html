<!DOCTYPE html>
<html>
<head>
    <title>Finance Teacher Chat</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="chat">

<header>
    <div class="header-container">
        <img src="css/logo.png" alt="Logo" class="logo">
        <div class="header-content">
            <h1>Finance Teacher Chat</h1>
            <nav>
                <a href="index.html">Home</a>
                <a href="assets.html">Assets</a>
                <a href="chat.html">Finance Teacher Chat</a>
                <a href="portfolio.html">Portfolio</a>
            </nav>
        </div>
    </div>
</header>

<div class="chat-wrapper">
    <div id="chat"></div>

    <div class="chat-input">
        <input type="text" id="question" placeholder="Type your question" />
        <button onclick="sendQuestion()">Ask</button>
    </div>
</div>

<script>
    const chatDiv = document.getElementById("chat");
    const questionInput = document.getElementById("question");

    function addMessage(role, text) {
        const div = document.createElement("div");
        div.className = "message " + role;
        div.textContent = text;
        chatDiv.appendChild(div);
        chatDiv.scrollTop = chatDiv.scrollHeight; // auto scroll
    }

    function extractContent(raw) {
        if (raw == null) return "";

        if (typeof raw === "object") {
            if (raw.content) return String(raw.content);
            if (raw.message && raw.message.content) return String(raw.message.content);

            if (Array.isArray(raw.choices) && raw.choices.length) {
                const c0 = raw.choices[0];
                if (c0 && c0.message && c0.message.content) return String(c0.message.content);
                if (c0 && c0.delta && c0.delta.content) return String(c0.delta.content);
            }
            try { return JSON.stringify(raw); } catch { return String(raw); }
        }

        if (typeof raw === "string") {
            const s = raw.trim();

            if (s.startsWith("{") || s.startsWith("[")) {
                try {
                    const obj = JSON.parse(s);
                    return extractContent(obj);
                } catch { /* nie JSON */ }
            }

            const m = s.match(/content=(["'])([\s\S]*?)\1/);
            if (m) return m[2];

            return s;
        }

        return String(raw);
    }

    async function sendQuestion() {
        const question = questionInput.value.trim();
        if (!question) return;

        addMessage("user", question);
        questionInput.value = "";

        try {
            const resp = await fetch("/api/chat/question?question=" + encodeURIComponent(question), {
                method: "POST"
            });
            const data = await resp.json();

            const answer = extractContent(data && data.answer);
            addMessage("assistant", answer || "No answer received");
        } catch (err) {
            addMessage("assistant", "Error: " + err.message);
        }
    }

    questionInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendQuestion();
    });
</script>

</body>
</html>
